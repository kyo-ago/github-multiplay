var Firepad=function(){var a=a||{};a.utils={},a.utils.makeEventEmitter=function(a,b){a.prototype.allowedEvents_=b,a.prototype.on=function(a,b,c){this.validateEventType_(a),this.eventListeners_=this.eventListeners_||{},this.eventListeners_[a]=this.eventListeners_[a]||[],this.eventListeners_[a].push({callback:b,context:c})},a.prototype.off=function(a,b){this.validateEventType_(a),this.eventListeners_=this.eventListeners_||{};for(var c=this.eventListeners_[a]||[],d=0;d<c.length;d++)if(c[d].callback===b)return c.splice(d,1),void 0},a.prototype.trigger=function(a){this.eventListeners_=this.eventListeners_||{};for(var b=this.eventListeners_[a]||[],c=0;c<b.length;c++)b[c].callback.apply(b[c].context,Array.prototype.slice.call(arguments,1))},a.prototype.validateEventType_=function(a){if(this.allowedEvents_&&-1===this.allowedEvents_.indexOf(a))throw new Error('Unknown event "'+a+'"')}},a.utils.elt=function(b,c,d){var e=document.createElement(b);if("string"==typeof c)a.utils.setTextContent(e,c);else if(c)for(var f=0;f<c.length;++f)e.appendChild(c[f]);for(var g in d||{})e.setAttribute(g,d[g]);return e},a.utils.setTextContent=function(a,b){a.innerHTML="",a.appendChild(document.createTextNode(b))},a.utils.on=function(a,b,c,d){a.addEventListener?a.addEventListener(b,c,d||!1):a.attachEvent&&a.attachEvent("on"+b,c)},a.utils.off=function(a,b,c,d){a.removeEventListener?a.removeEventListener(b,c,d||!1):a.detachEvent&&a.detachEvent("on"+b,c)},a.utils.preventDefault=function(a){a.preventDefault?a.preventDefault():a.returnValue=!1},a.utils.stopPropagation=function(a){a.stopPropagation?a.stopPropagation():a.cancelBubble=!0},a.utils.stopEvent=function(b){a.utils.preventDefault(b),a.utils.stopPropagation(b)},a.utils.stopEventAnd=function(b){return function(c){return b(c),a.utils.stopEvent(c),!1}},a.utils.assert=function(a,b){if(!a)throw new Error(b||"assertion error")},a.utils.log=function(){if("undefined"!=typeof console&&"undefined"!=typeof console.log){for(var a=["Firepad:"],b=0;b<arguments.length;b++)a.push(arguments[b]);console.log.apply(console,a)}};var a=a||{};a.Span=function(){function a(a,b){this.pos=a,this.length=b}return a.prototype.end=function(){return this.pos+this.length},a}();var a=a||{};a.TextOp=function(){function b(a){this.type=a,this.chars=null,this.text=null,this.attributes=null,"insert"===a?(this.text=arguments[1],c.assert("string"==typeof this.text),this.attributes=arguments[2]||{},c.assert("object"==typeof this.attributes)):"delete"===a?(this.chars=arguments[1],c.assert("number"==typeof this.chars)):"retain"===a&&(this.chars=arguments[1],c.assert("number"==typeof this.chars),this.attributes=arguments[2]||{},c.assert("object"==typeof this.attributes))}var c=a.utils;return b.prototype.isInsert=function(){return"insert"===this.type},b.prototype.isDelete=function(){return"delete"===this.type},b.prototype.isRetain=function(){return"retain"===this.type},b.prototype.equals=function(a){return this.type===a.type&&this.text===a.text&&this.chars===a.chars&&this.attributesEqual(a.attributes)},b.prototype.attributesEqual=function(a){for(var b in this.attributes)if(this.attributes[b]!==a[b])return!1;for(b in a)if(this.attributes[b]!==a[b])return!1;return!0},b.prototype.hasEmptyAttributes=function(){var a=!0;for(var b in this.attributes){a=!1;break}return a},b}();var a=a||{};a.TextOperation=function(){"use strict";function b(){return this&&this.constructor===b?(this.ops=[],this.baseLength=0,this.targetLength=0,void 0):new b}function c(a){var b=a.ops;switch(b.length){case 1:return b[0];case 2:return b[0].isRetain()?b[1]:b[1].isRetain()?b[0]:null;case 3:if(b[0].isRetain()&&b[2].isRetain())return b[1]}return null}function d(a){return a.ops[0].isRetain()?a.ops[0].chars:0}var e=a.TextOp,f=a.utils;return b.prototype.equals=function(a){if(this.baseLength!==a.baseLength)return!1;if(this.targetLength!==a.targetLength)return!1;if(this.ops.length!==a.ops.length)return!1;for(var b=0;b<this.ops.length;b++)if(!this.ops[b].equals(a.ops[b]))return!1;return!0},b.prototype.retain=function(a,b){if("number"!=typeof a||0>a)throw new Error("retain expects a positive integer.");if(0===a)return this;this.baseLength+=a,this.targetLength+=a,b=b||{};var c=this.ops.length>0?this.ops[this.ops.length-1]:null;return c&&c.isRetain()&&c.attributesEqual(b)?c.chars+=a:this.ops.push(new e("retain",a,b)),this},b.prototype.insert=function(a,b){if("string"!=typeof a)throw new Error("insert expects a string");if(""===a)return this;b=b||{},this.targetLength+=a.length;var c=this.ops.length>0?this.ops[this.ops.length-1]:null,d=this.ops.length>1?this.ops[this.ops.length-2]:null;return c&&c.isInsert()&&c.attributesEqual(b)?c.text+=a:c&&c.isDelete()?d&&d.isInsert()&&d.attributesEqual(b)?d.text+=a:(this.ops[this.ops.length-1]=new e("insert",a,b),this.ops.push(c)):this.ops.push(new e("insert",a,b)),this},b.prototype["delete"]=function(a){if("string"==typeof a&&(a=a.length),"number"!=typeof a||0>a)throw new Error("delete expects a positive integer or a string");if(0===a)return this;this.baseLength+=a;var b=this.ops.length>0?this.ops[this.ops.length-1]:null;return b&&b.isDelete()?b.chars+=a:this.ops.push(new e("delete",a)),this},b.prototype.isNoop=function(){return 0===this.ops.length||1===this.ops.length&&this.ops[0].isRetain()&&this.ops[0].hasEmptyAttributes()},b.prototype.clone=function(){for(var a=new b,c=0;c<this.ops.length;c++)this.ops[c].isRetain()?a.retain(this.ops[c].chars,this.ops[c].attributes):this.ops[c].isInsert()?a.insert(this.ops[c].text,this.ops[c].attributes):a["delete"](this.ops[c].chars);return a},b.prototype.toString=function(){var a=Array.prototype.map||function(a){for(var b=this,c=[],d=0,e=b.length;e>d;d++)c[d]=a(b[d]);return c};return a.call(this.ops,function(a){return a.isRetain()?"retain "+a.chars:a.isInsert()?"insert '"+a.text+"'":"delete "+a.chars}).join(", ")},b.prototype.toJSON=function(){for(var a=[],b=0;b<this.ops.length;b++)this.ops[b].hasEmptyAttributes()||a.push(this.ops[b].attributes),"retain"===this.ops[b].type?a.push(this.ops[b].chars):"insert"===this.ops[b].type?a.push(this.ops[b].text):"delete"===this.ops[b].type&&a.push(-this.ops[b].chars);return 0===a.length&&a.push(0),a},b.fromJSON=function(a){for(var c=new b,d=0,e=a.length;e>d;d++){var g=a[d],h={};"object"==typeof g&&(h=g,d++,g=a[d]),"number"==typeof g?g>0?c.retain(g,h):c["delete"](-g):(f.assert("string"==typeof g),c.insert(g,h))}return c},b.prototype.apply=function(a,b,c){var d=this;if(b=b||[],c=c||[],a.length!==d.baseLength)throw new Error("The operation's base length must be equal to the string's length.");for(var e,g,h=[],i=0,j=0,k=this.ops,l=0,m=k.length;m>l;l++){var n=k[l];if(n.isRetain()){if(j+n.chars>a.length)throw new Error("Operation can't retain more characters than are left in the string.");for(h[i++]=a.slice(j,j+n.chars),e=0;e<n.chars;e++){var o=b[j+e]||{},p={};for(g in o)p[g]=o[g],f.assert(p[g]!==!1);for(g in n.attributes)n.attributes[g]===!1?delete p[g]:p[g]=n.attributes[g],f.assert(p[g]!==!1);c.push(p)}j+=n.chars}else if(n.isInsert())for(h[i++]=n.text,e=0;e<n.text.length;e++){var q={};for(g in n.attributes)q[g]=n.attributes[g],f.assert(q[g]!==!1);c.push(q)}else j+=n.chars}if(j!==a.length)throw new Error("The operation didn't operate on the whole string.");var r=h.join("");return f.assert(r.length===c.length),r},b.prototype.invert=function(a){for(var c=0,d=new b,e=this.ops,f=0,g=e.length;g>f;f++){var h=e[f];h.isRetain()?(d.retain(h.chars),c+=h.chars):h.isInsert()?d["delete"](h.text.length):(d.insert(a.slice(c,c+h.chars)),c+=h.chars)}return d},b.prototype.compose=function(a){function c(a,b,c){var d,e={};for(d in a)e[d]=a[d];for(d in b)c&&b[d]===!1?delete e[d]:e[d]=b[d];return e}var d=this;if(d.targetLength!==a.baseLength)throw new Error("The base length of the second operation has to be the target length of the first operation");for(var e,f=new b,g=d.clone().ops,h=a.clone().ops,i=0,j=0,k=g[i++],l=h[j++];;){if("undefined"==typeof k&&"undefined"==typeof l)break;if(k&&k.isDelete())f["delete"](k.chars),k=g[i++];else if(l&&l.isInsert())f.insert(l.text,l.attributes),l=h[j++];else{if("undefined"==typeof k)throw new Error("Cannot compose operations: first operation is too short.");if("undefined"==typeof l)throw new Error("Cannot compose operations: first operation is too long.");if(k.isRetain()&&l.isRetain())e=c(k.attributes,l.attributes),k.chars>l.chars?(f.retain(l.chars,e),k.chars-=l.chars,l=h[j++]):k.chars===l.chars?(f.retain(k.chars,e),k=g[i++],l=h[j++]):(f.retain(k.chars,e),l.chars-=k.chars,k=g[i++]);else if(k.isInsert()&&l.isDelete())k.text.length>l.chars?(k.text=k.text.slice(l.chars),l=h[j++]):k.text.length===l.chars?(k=g[i++],l=h[j++]):(l.chars-=k.text.length,k=g[i++]);else if(k.isInsert()&&l.isRetain())e=c(k.attributes,l.attributes,!0),k.text.length>l.chars?(f.insert(k.text.slice(0,l.chars),e),k.text=k.text.slice(l.chars),l=h[j++]):k.text.length===l.chars?(f.insert(k.text,e),k=g[i++],l=h[j++]):(f.insert(k.text,e),l.chars-=k.text.length,k=g[i++]);else{if(!k.isRetain()||!l.isDelete())throw new Error("This shouldn't happen: op1: "+JSON.stringify(k)+", op2: "+JSON.stringify(l));k.chars>l.chars?(f["delete"](l.chars),k.chars-=l.chars,l=h[j++]):k.chars===l.chars?(f["delete"](l.chars),k=g[i++],l=h[j++]):(f["delete"](k.chars),l.chars-=k.chars,k=g[i++])}}}return f},b.prototype.shouldBeComposedWith=function(a){if(this.isNoop()||a.isNoop())return!0;var b=d(this),e=d(a),f=c(this),g=c(a);return f&&g?f.isInsert()&&g.isInsert()?b+f.text.length===e:f.isDelete()&&g.isDelete()?e+g.chars===b||b===e:!1:!1},b.prototype.shouldBeComposedWithInverted=function(a){if(this.isNoop()||a.isNoop())return!0;var b=d(this),e=d(a),f=c(this),g=c(a);return f&&g?f.isInsert()&&g.isInsert()?b+f.text.length===e||b===e:f.isDelete()&&g.isDelete()?e+g.chars===b:!1:!1},b.transformAttributes=function(a,b){var c,d={},e={},g={};for(c in a)g[c]=!0;for(c in b)g[c]=!0;for(c in g){var h=a[c],i=b[c];f.assert(null!=h||null!=i),null==h?e[c]=i:null==i?d[c]=h:h===i||(d[c]=h)}return[d,e]},b.transform=function(a,c){if(a.baseLength!==c.baseLength)throw new Error("Both operations have to have the same base length");for(var d=new b,e=new b,f=a.clone().ops,g=c.clone().ops,h=0,i=0,j=f[h++],k=g[i++];;){if("undefined"==typeof j&&"undefined"==typeof k)break;if(j&&j.isInsert())d.insert(j.text,j.attributes),e.retain(j.text.length),j=f[h++];else if(k&&k.isInsert())d.retain(k.text.length),e.insert(k.text,k.attributes),k=g[i++];else{if("undefined"==typeof j)throw new Error("Cannot transform operations: first operation is too short.");if("undefined"==typeof k)throw new Error("Cannot transform operations: first operation is too long.");var l;if(j.isRetain()&&k.isRetain()){var m=b.transformAttributes(j.attributes,k.attributes);j.chars>k.chars?(l=k.chars,j.chars-=k.chars,k=g[i++]):j.chars===k.chars?(l=k.chars,j=f[h++],k=g[i++]):(l=j.chars,k.chars-=j.chars,j=f[h++]),d.retain(l,m[0]),e.retain(l,m[1])}else if(j.isDelete()&&k.isDelete())j.chars>k.chars?(j.chars-=k.chars,k=g[i++]):j.chars===k.chars?(j=f[h++],k=g[i++]):(k.chars-=j.chars,j=f[h++]);else if(j.isDelete()&&k.isRetain())j.chars>k.chars?(l=k.chars,j.chars-=k.chars,k=g[i++]):j.chars===k.chars?(l=k.chars,j=f[h++],k=g[i++]):(l=j.chars,k.chars-=j.chars,j=f[h++]),d["delete"](l);else{if(!j.isRetain()||!k.isDelete())throw new Error("The two operations aren't compatible");j.chars>k.chars?(l=k.chars,j.chars-=k.chars,k=g[i++]):j.chars===k.chars?(l=j.chars,j=f[h++],k=g[i++]):(l=j.chars,k.chars-=j.chars,j=f[h++]),e["delete"](l)}}}return[d,e]},b}();var a=a||{};a.AnnotationList=function(){function b(a,b){if(!a)throw new Error("AnnotationList assertion failed"+(b?": "+b:""))}function c(a,b){this.pos=a,this.length=b.length,this.annotation=b.annotation,this.attachedObject_=b.attachedObject}function d(a,b){this.pos=a,this.length=b.length,this.annotation=b.annotation,this.node_=b}function e(a){this.head_=new f(0,h),this.changeHandler_=a}function f(a,b){this.length=a,this.annotation=b,this.attachedObject=null,this.next=null}var g=a.Span;c.prototype.getAttachedObject=function(){return this.attachedObject_},d.prototype.attachObject=function(a){this.node_.attachedObject=a};var h={equals:function(){return!1}};return e.prototype.insertAnnotatedSpan=function(a,c){this.wrapOperation_(new g(a.pos,0),function(d,e){b(!e||null===e.next);var g=new f(a.length,c);if(e){b(a.pos>d&&a.pos<d+e.length);var i=new f(0,h);return i.next=new f(a.pos-d,e.annotation),i.next.next=g,g.next=new f(d+e.length-a.pos,e.annotation),i.next}return g})},e.prototype.removeSpan=function(a){0!==a.length&&this.wrapOperation_(a,function(c,d){b(null!==d);var e=new f(0,h),g=e;for(a.pos>c&&(g.next=new f(a.pos-c,d.annotation),g=g.next);a.end()>c+d.length;)c+=d.length,d=d.next;var i=c+d.length-a.end();return i>0&&(g.next=new f(i,d.annotation)),e.next})},e.prototype.updateSpan=function(a,c){0!==a.length&&this.wrapOperation_(a,function(d,e){b(null!==e);var g=new f(0,h),i=g,j=d,k=a.pos-j;for(b(k<e.length),k>0&&(i.next=new f(k,e.annotation),i=i.next,j+=i.length);null!==e&&a.end()>=d+e.length;){var l=d+e.length-j;i.next=new f(l,c(e.annotation,l)),i=i.next,d+=e.length,e=e.next,j=d}var m=a.end()-j;return m>0&&(b(m<e.length),i.next=new f(m,c(e.annotation,m)),i=i.next,j+=i.length,i.next=new f(d+e.length-j,e.annotation)),g.next})},e.prototype.wrapOperation_=function(a,b){if(a.pos<0)throw new Error("Span start cannot be negative.");var e,g=[],h=[],i=this.getAffectedNodes_(a);null!==i.start?(e=i.end.next,i.end.next=null):e=i.succ;var j=b(i.startPos,i.start),k=!1,l=!1;if(j){this.mergeNodesWithSameAnnotations_(j);var m;for(i.pred&&i.pred.annotation.equals(j.annotation)?(k=!0,j.length+=i.pred.length,i.beforePred.next=j,m=i.predPos):(i.beforeStart.next=j,m=i.startPos);j.next;)h.push(new d(m,j)),m+=j.length,j=j.next;i.succ&&i.succ.annotation.equals(j.annotation)?(j.length+=i.succ.length,l=!0,j.next=i.succ.next):j.next=e,h.push(new d(m,j))}else i.pred&&i.succ&&i.pred.annotation.equals(i.succ.annotation)?(k=!0,l=!0,j=new f(i.pred.length+i.succ.length,i.pred.annotation),i.beforePred.next=j,j.next=i.succ.next,h.push(new d(i.startPos-i.start.length,j))):i.beforeStart.next=e;k&&g.push(new c(i.predPos,i.pred));for(var n=i.startPos,o=i.start;null!==o;)g.push(new c(n,o)),n+=o.length,o=o.next;l&&g.push(new c(n,i.succ)),this.changeHandler_(g,h)},e.prototype.getAffectedNodes_=function(a){for(var b={},c=null,d=this.head_,e=d.next,f=0;null!==e&&a.pos>=f+e.length;)f+=e.length,c=d,d=e,e=e.next;if(null===e&&(0!==a.length||a.pos!==f))throw new Error("Span start exceeds the bounds of the AnnotationList.");for(b.startPos=f,b.start=0===a.length&&a.pos===f?null:e,b.beforeStart=d,f===a.pos&&f>0?(b.pred=d,b.predPos=f-d.length,b.beforePred=c):b.pred=null;null!==e&&a.end()>f;)f+=e.length,d=e,e=e.next;if(a.end()>f)throw new Error("Span end exceeds the bounds of the AnnotationList.");return b.end=0===a.length&&a.end()===f?null:d,b.succ=f===a.end()?e:null,b},e.prototype.mergeNodesWithSameAnnotations_=function(a){if(a)for(var b=null,c=a;c;)b&&b.annotation.equals(c.annotation)?(b.length+=c.length,b.next=c.next):b=c,c=c.next},e.prototype.forEach=function(a){for(var b=this.head_.next;null!==b;)a(b.length,b.annotation,b.attachedObject),b=b.next},e.prototype.getAnnotatedSpansForPos=function(a){for(var b=0,d=this.head_.next,e=null;null!==d&&b+d.length<=a;)b+=d.length,e=d,d=d.next;if(null===d&&b!==a)throw new Error("pos exceeds the bounds of the AnnotationList");var f=[];return b===a&&e&&f.push(new c(b-e.length,e)),d&&f.push(new c(b,d)),f},e.prototype.getAnnotatedSpansForSpan=function(a){if(0===a.length)return[];for(var b=[],c=this.getAffectedNodes_(a),d=c.startPos,e=c.start;null!==e&&d<a.end();){var f=Math.max(d,a.pos),h=Math.min(d+e.length,a.end()),i=new g(f,h-f);i.annotation=e.annotation,b.push(i),d+=e.length,e=e.next}return b},e.prototype.count=function(){for(var a=0,c=this.head_.next,d=null;null!==c;)d&&b(!d.annotation.equals(c.annotation)),d=c,c=c.next,a++;return a},f.prototype.clone=function(){var a=new f(this.spanLength,this.annotation);return a.next=this.next,a},e}();var a=a||{};a.Cursor=function(){"use strict";function a(a,b){this.position=a,this.selectionEnd=b}return a.fromJSON=function(b){return new a(b.position,b.selectionEnd)},a.prototype.equals=function(a){return this.position===a.position&&this.selectionEnd===a.selectionEnd},a.prototype.compose=function(a){return a},a.prototype.transform=function(b){function c(a){for(var c=a,d=b.ops,e=0,f=b.ops.length;f>e&&(d[e].isRetain()?a-=d[e].chars:d[e].isInsert()?c+=d[e].text.length:(c-=Math.min(a,d[e].chars),a-=d[e].chars),!(0>a));e++);return c}var d=c(this.position);return this.position===this.selectionEnd?new a(d,d):new a(d,c(this.selectionEnd))},a}();var a=a||{};a.FirebaseAdapter=function(){function b(a,b,c){this.ref_=a,this.ready_=!1,this.firebaseCallbacks_=[],this.zombie_=!1,this.document_=new f,this.revision_=0,this.pendingReceivedRevisions_={},this.setUserId(b),this.setColor(c);var d=this;this.firebaseOn_(a.root().child(".info/connected"),"value",function(a){a.val()===!0&&d.initializeUserData_()},this),setTimeout(function(){d.monitorHistory_()},0),this.on("ready",function(){d.monitorCursors_()})}function c(a,b){if(!a)throw new Error(b||"assertion error")}function d(a){if(0===a)return"A0";for(var b="";a>0;){var c=a%i.length;b=i[c]+b,a-=c,a/=i.length}var d=i[b.length+9];return d+b}function e(a){c(a.length>0&&a[0]===i[a.length+8]);for(var b=0,d=1;d<a.length;d++)b*=i.length,b+=i.indexOf(a[d]);return b}var f=a.TextOperation,g=a.utils,h=100;g.makeEventEmitter(b,["ready","cursor","operation","ack","retry"]),b.prototype.dispose=function(){this.removeFirebaseCallbacks_(),this.userRef_.child("cursor").remove(),this.userRef_.child("color").remove(),this.ref_=null,this.document_=null,this.zombie_=!0},b.prototype.setUserId=function(a){this.userRef_&&(this.userRef_.child("cursor").remove(),this.userRef_.child("cursor").onDisconnect().cancel(),this.userRef_.child("color").remove(),this.userRef_.child("color").onDisconnect().cancel()),this.userId_=a,this.userRef_=this.ref_.child("users").child(a),this.initializeUserData_()},b.prototype.isHistoryEmpty=function(){return c(this.ready_,"Not ready yet."),0===this.revision_},b.prototype.sendOperation=function(a,b){function e(a,b,c){f.ref_.child("history").child(a).transaction(function(a){return null===a?b:void 0},function(d,h){if(d){if("disconnect"!==d.message)throw g.log("Transaction failure!",d),d;f.sent_&&f.sent_.id===a&&setTimeout(function(){e(a,b,c)},0)}else h&&f.sendCursor(c)},!1)}var f=this;if(!this.ready_)return this.on("ready",function(){f.trigger("retry")}),void 0;c(this.document_.targetLength===a.baseLength,"sendOperation() called with invalid operation.");var h=d(this.revision_);this.sent_={id:h,op:a},e(h,{a:f.userId_,o:a.toJSON()},b)},b.prototype.sendCursor=function(a){this.userRef_.child("cursor").set(a),this.cursor_=a},b.prototype.setColor=function(a){this.userRef_.child("color").set(a),this.color_=a},b.prototype.getDocument=function(){return this.document_},b.prototype.registerCallbacks=function(a){for(var b in a)this.on(b,a[b])},b.prototype.initializeUserData_=function(){this.userRef_.child("cursor").onDisconnect().remove(),this.userRef_.child("color").onDisconnect().remove(),this.sendCursor(this.cursor_||null),this.setColor(this.color_||null)},b.prototype.monitorCursors_=function(){function a(a){var b=a.name();if(b!==c.userId_){var d=a.val();c.trigger("cursor",b,d.cursor,d.color)}}var b=this.ref_.child("users"),c=this,d={};this.firebaseOn_(b,"child_added",a),this.firebaseOn_(b,"child_changed",a),this.firebaseOn_(b,"child_removed",function(a){var b=a.name();c.firebaseOff_(a.ref(),"value",d[b]),c.trigger("cursor",b,null)})},b.prototype.monitorHistory_=function(){var a=this;this.ref_.child("checkpoint").once("value",function(b){if(!a.zombie_){var c=b.child("id").val(),d=b.child("o").val(),f=b.child("a").val();null!=d&&null!=c&&null!==f?(a.pendingReceivedRevisions_[c]={o:d,a:f},a.checkpointRevision_=e(c),a.monitorHistoryStartingAt_(a.checkpointRevision_+1)):(a.checkpointRevision_=0,a.monitorHistoryStartingAt_(a.checkpointRevision_))}})},b.prototype.monitorHistoryStartingAt_=function(a){var b=this.ref_.child("history").startAt(null,d(a)),c=this;setTimeout(function(){c.firebaseOn_(b,"child_added",function(a){var b=a.name();c.pendingReceivedRevisions_[b]=a.val(),c.ready_&&c.handlePendingReceivedRevisions_()}),b.once("value",function(){c.handleInitialRevisions_()})},0)},b.prototype.handleInitialRevisions_=function(){c(!this.ready_,"Should not be called multiple times."),this.revision_=this.checkpointRevision_;for(var a=d(this.revision_),b=this.pendingReceivedRevisions_;null!=b[a];){var e=this.parseRevision_(b[a]);e?this.document_=this.document_.compose(e.operation):g.log("Invalid operation.",this.ref_.toString(),a,b[a]),delete b[a],this.revision_++,a=d(this.revision_)}this.trigger("operation",this.document_),this.ready_=!0;var f=this;setTimeout(function(){f.trigger("ready")},0)},b.prototype.handlePendingReceivedRevisions_=function(){for(var a=this.pendingReceivedRevisions_,b=d(this.revision_),c=!1;null!=a[b];){this.revision_++;var e=this.parseRevision_(a[b]);e?(this.document_=this.document_.compose(e.operation),this.sent_&&b===this.sent_.id?this.sent_.op.equals(e.operation)&&e.author===this.userId_?(0===this.revision_%h&&this.saveCheckpoint_(),this.sent_=null,this.trigger("ack")):(c=!0,this.trigger("operation",e.operation)):this.trigger("operation",e.operation)):g.log("Invalid operation.",this.ref_.toString(),b,a[b]),delete a[b],b=d(this.revision_)}c&&(this.sent_=null,this.trigger("retry"))},b.prototype.parseRevision_=function(a){if("object"!=typeof a)return null;if("string"!=typeof a.a||"object"!=typeof a.o)return null;var b=null;try{b=f.fromJSON(a.o)}catch(c){return null}return b.baseLength!==this.document_.targetLength?null:{author:a.a,operation:b}},b.prototype.saveCheckpoint_=function(){this.ref_.child("checkpoint").set({a:this.userId_,o:this.document_.toJSON(),id:d(this.revision_-1)})},b.prototype.firebaseOn_=function(a,b,c,d){return this.firebaseCallbacks_.push({ref:a,eventType:b,callback:c,context:d}),a.on(b,c,d),c},b.prototype.firebaseOff_=function(a,b,c,d){a.off(b,c,d);for(var e=0;e<this.firebaseCallbacks_.length;e++){var f=this.firebaseCallbacks_[e];if(f.ref===a&&f.eventType===b&&f.callback===c&&f.context===d){this.firebaseCallbacks_.splice(e,1);break}}},b.prototype.removeFirebaseCallbacks_=function(){for(var a=0;a<this.firebaseCallbacks_.length;a++){var b=this.firebaseCallbacks_[a];b.ref.off(b.eventType,b.callback,b.context)}this.firebaseCallbacks_=[]};var i="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";return b}();var a=a||{};a.RichTextToolbar=function(){function b(){this.element_=this.makeElement_()}var c=a.utils;return c.makeEventEmitter(b,["bold","italic","underline","font","font-size","color","unordered-list","ordered-list","todo"]),b.prototype.element=function(){return this.element_},b.prototype.makeElement_=function(){var a=this,b=c.elt("a","B",{"class":"firepad-btn firepad-btn-bold"});c.on(b,"click",c.stopEventAnd(function(){a.trigger("bold")}));var d=c.elt("a","I",{"class":"firepad-btn firepad-btn-italic"});c.on(d,"click",c.stopEventAnd(function(){a.trigger("italic")}));var e=c.elt("a","U",{"class":"firepad-btn firepad-btn-underline"});c.on(e,"click",c.stopEventAnd(function(){a.trigger("underline")}));var f=c.elt("a",[c.elt("div",[],{"class":"firepad-btn-icon"})],{"class":"firepad-btn firepad-btn-ul"});c.on(f,"click",c.stopEventAnd(function(){a.trigger("unordered-list")}));var g=c.elt("a",[c.elt("div",[],{"class":"firepad-btn-icon"})],{"class":"firepad-btn firepad-btn-ol"});c.on(g,"click",c.stopEventAnd(function(){a.trigger("ordered-list")}));var h=c.elt("a",[c.elt("div",[],{"class":"firepad-btn-icon"})],{"class":"firepad-btn firepad-btn-todo"});c.on(h,"click",c.stopEventAnd(function(){a.trigger("todo")}));var i=this.makeFontDropdown_(),j=this.makeFontSizeDropdown_(),k=this.makeColorDropdown_(),l=c.elt("div",[c.elt("div",[i],{"class":"firepad-btn-group"}),c.elt("div",[j],{"class":"firepad-btn-group"}),c.elt("div",[k],{"class":"firepad-btn-group"}),c.elt("div",[b,d,e],{"class":"firepad-btn-group"}),c.elt("div",[f,g],{"class":"firepad-btn-group"})],{"class":"firepad-toolbar"});return l},b.prototype.makeFontDropdown_=function(){for(var a=["Arial","Comic Sans MS","Courier New","Impact","Times New Roman","Verdana"],b=[],d=0;d<a.length;d++){var e=c.elt("span",a[d]);e.setAttribute("style","font-family:"+a[d]),b.push({content:e,value:a[d]})}return this.makeDropdown_("Font","font",b)},b.prototype.makeFontSizeDropdown_=function(){for(var a=[9,10,12,14,18,24,32,42],b=[],d=0;d<a.length;d++){var e=c.elt("span",a[d].toString());e.setAttribute("style","font-size:"+a[d]+"px; line-height:"+(a[d]-6)+"px;"),b.push({content:e,value:a[d]})}return this.makeDropdown_("Size","font-size",b,"px")},b.prototype.makeColorDropdown_=function(){for(var a=["black","red","green","blue","yellow","cyan","magenta","grey"],b=[],d=0;d<a.length;d++){var e=c.elt("div");e.className="firepad-color-dropdown-item",e.setAttribute("style","background-color:"+a[d]),b.push({content:e,value:a[d]})}return this.makeDropdown_("Color","color",b)},b.prototype.makeDropdown_=function(a,b,d,e){function f(){l||(k.style.display="block",c.on(document,"click",g,!0),l=!0)}function g(){l&&(k.style.display="",c.off(document,"click",g,!0),l=!1),m=!0,setTimeout(function(){m=!1},0)}function h(a,d){"object"!=typeof a&&(a=document.createTextNode(String(a)));var f=c.elt("a",[a]);c.on(f,"click",c.stopEventAnd(function(){g(),i.trigger(b,d+e)})),k.appendChild(f)}e=e||"";var i=this,j=c.elt("a",a+" ▾",{"class":"firepad-btn firepad-dropdown"}),k=c.elt("ul",[],{"class":"firepad-dropdown-menu"});j.appendChild(k);for(var l=!1,m=!1,n=0;n<d.length;n++){var o=d[n].content,p=d[n].value;h(o,p)}return c.on(j,"click",c.stopEventAnd(function(){m||f()})),j},b}();var a=a||{};a.WrappedOperation=function(){"use strict";function a(a,b){this.wrapped=a,this.meta=b}function b(a,b){for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c])}function c(a,c){if(a&&"object"==typeof a){if("function"==typeof a.compose)return a.compose(c);var d={};return b(a,d),b(c,d),d}return c}function d(a,b){return a&&"object"==typeof a&&"function"==typeof a.transform?a.transform(b):a}return a.prototype.apply=function(){return this.wrapped.apply.apply(this.wrapped,arguments)},a.prototype.invert=function(){var b=this.meta;return new a(this.wrapped.invert.apply(this.wrapped,arguments),b&&"object"==typeof b&&"function"==typeof b.invert?b.invert.apply(b,arguments):b)},a.prototype.compose=function(b){return new a(this.wrapped.compose(b.wrapped),c(this.meta,b.meta))},a.transform=function(b,c){var e=b.wrapped.constructor.transform,f=e(b.wrapped,c.wrapped);return[new a(f[0],d(b.meta,c.wrapped)),new a(f[1],d(c.meta,b.wrapped))]},a}();var a=a||{};a.UndoManager=function(){"use strict";function a(a){this.maxItems=a||50,this.state=c,this.dontCompose=!1,this.undoStack=[],this.redoStack=[]}function b(a,b){for(var c=[],d=b.constructor,e=a.length-1;e>=0;e--){var f=d.transform(a[e],b);"function"==typeof f[0].isNoop&&f[0].isNoop()||c.push(f[0]),b=f[1]}return c.reverse()}var c="normal",d="undoing",e="redoing";return a.prototype.add=function(a,b){if(this.state===d)this.redoStack.push(a),this.dontCompose=!0;else if(this.state===e)this.undoStack.push(a),this.dontCompose=!0;else{var c=this.undoStack;!this.dontCompose&&b&&c.length>0?c.push(a.compose(c.pop())):(c.push(a),c.length>this.maxItems&&c.shift()),this.dontCompose=!1,this.redoStack=[]}},a.prototype.transform=function(a){this.undoStack=b(this.undoStack,a),this.redoStack=b(this.redoStack,a)},a.prototype.performUndo=function(a){if(this.state=d,0===this.undoStack.length)throw new Error("undo not possible");a(this.undoStack.pop()),this.state=c},a.prototype.performRedo=function(a){if(this.state=e,0===this.redoStack.length)throw new Error("redo not possible");a(this.redoStack.pop()),this.state=c},a.prototype.canUndo=function(){return 0!==this.undoStack.length},a.prototype.canRedo=function(){return 0!==this.redoStack.length},a.prototype.isUndoing=function(){return this.state===d},a.prototype.isRedoing=function(){return this.state===e},a}();var a=a||{};a.Client=function(){"use strict";function a(){this.state=e}function b(){}function c(a){this.outstanding=a}function d(a,b){this.outstanding=a,this.buffer=b}a.prototype.setState=function(a){this.state=a},a.prototype.applyClient=function(a){this.setState(this.state.applyClient(this,a))},a.prototype.applyServer=function(a){this.setState(this.state.applyServer(this,a))},a.prototype.serverAck=function(){this.setState(this.state.serverAck(this))},a.prototype.transformCursor=function(a){return this.state.transformCursor(a)},a.prototype.serverRetry=function(){this.setState(this.state.serverRetry(this))},a.prototype.sendOperation=function(){throw new Error("sendOperation must be defined in child class")},a.prototype.applyOperation=function(){throw new Error("applyOperation must be defined in child class")},a.Synchronized=b,b.prototype.applyClient=function(a,b){return a.sendOperation(b),new c(b)},b.prototype.applyServer=function(a,b){return a.applyOperation(b),this},b.prototype.serverAck=function(){throw new Error("There is no pending operation.")},b.prototype.serverRetry=function(){throw new Error("There is no pending operation.")},b.prototype.transformCursor=function(a){return a};var e=new b;return a.AwaitingConfirm=c,c.prototype.applyClient=function(a,b){return new d(this.outstanding,b)},c.prototype.applyServer=function(a,b){var d=b.constructor.transform(this.outstanding,b);return a.applyOperation(d[1]),new c(d[0])},c.prototype.serverAck=function(){return e},c.prototype.serverRetry=function(a){return a.sendOperation(this.outstanding),this},c.prototype.transformCursor=function(a){return a.transform(this.outstanding)},a.AwaitingWithBuffer=d,d.prototype.applyClient=function(a,b){var c=this.buffer.compose(b);return new d(this.outstanding,c)},d.prototype.applyServer=function(a,b){var c=b.constructor.transform,e=c(this.outstanding,b),f=c(this.buffer,e[1]);return a.applyOperation(f[1]),new d(e[0],f[0])},d.prototype.serverRetry=function(a){var b=this.outstanding.compose(this.buffer);return a.sendOperation(b),new c(b)},d.prototype.serverAck=function(a){return a.sendOperation(this.buffer),new c(this.buffer)},d.prototype.transformCursor=function(a){return a.transform(this.outstanding).transform(this.buffer)},a}();var a=a||{};a.EditorClient=function(){"use strict";function b(a,b){this.cursorBefore=a,this.cursorAfter=b}function c(a,b){this.id=a,this.editorAdapter=b,this.li=document.createElement("li")}function d(a,b){g.call(this),this.serverAdapter=a,this.editorAdapter=b,this.undoManager=new i,this.clients={};var c=this;this.editorAdapter.registerCallbacks({change:function(a,b){c.onChange(a,b)},cursorActivity:function(){c.onCursorActivity()},blur:function(){c.onBlur()}}),this.editorAdapter.registerUndo(function(){c.undo()}),this.editorAdapter.registerRedo(function(){c.redo()}),this.serverAdapter.registerCallbacks({ack:function(){c.serverAck()},retry:function(){c.serverRetry()},operation:function(a){c.applyServer(a)},cursor:function(a,b,d){var e=c.getClientObject(a);b?(e.setColor(d),e.updateCursor(c.transformCursor(h.fromJSON(b)))):e.removeCursor()}})}function e(a,b){function c(){}c.prototype=b.prototype,a.prototype=new c,a.prototype.constructor=a}function f(a){return a[a.length-1]}var g=a.Client,h=a.Cursor,i=a.UndoManager,j=a.WrappedOperation;return b.prototype.invert=function(){return new b(this.cursorAfter,this.cursorBefore)},b.prototype.compose=function(a){return new b(this.cursorBefore,a.cursorAfter)},b.prototype.transform=function(a){return new b(this.cursorBefore?this.cursorBefore.transform(a):null,this.cursorAfter?this.cursorAfter.transform(a):null)},c.prototype.setColor=function(a){this.color=a},c.prototype.updateCursor=function(a){this.removeCursor(),this.cursor=a,this.mark=this.editorAdapter.setOtherCursor(a,this.color,this.id)},c.prototype.removeCursor=function(){this.mark&&this.mark.clear()},e(d,g),d.prototype.getClientObject=function(a){var b=this.clients[a];
return b?b:this.clients[a]=new c(a,this.editorAdapter)},d.prototype.applyUnredo=function(a){this.undoManager.add(this.editorAdapter.invertOperation(a)),this.editorAdapter.applyOperation(a.wrapped),this.cursor=a.meta.cursorAfter,this.editorAdapter.setCursor(this.cursor),this.applyClient(a.wrapped)},d.prototype.undo=function(){var a=this;this.undoManager.canUndo()&&this.undoManager.performUndo(function(b){a.applyUnredo(b)})},d.prototype.redo=function(){var a=this;this.undoManager.canRedo()&&this.undoManager.performRedo(function(b){a.applyUnredo(b)})},d.prototype.onChange=function(a,c){var d=this.cursor;this.updateCursor();var e=this.undoManager.undoStack.length>0&&c.shouldBeComposedWithInverted(f(this.undoManager.undoStack).wrapped),g=new b(this.cursor,d);this.undoManager.add(new j(c,g),e),this.applyClient(a)},d.prototype.updateCursor=function(){this.cursor=this.editorAdapter.getCursor()},d.prototype.onCursorActivity=function(){var a=this.cursor;this.updateCursor(),a&&this.cursor.equals(a)||this.sendCursor(this.cursor)},d.prototype.onBlur=function(){this.cursor=null,this.sendCursor(null)},d.prototype.sendCursor=function(a){this.state instanceof g.AwaitingWithBuffer||this.serverAdapter.sendCursor(a)},d.prototype.sendOperation=function(a){this.serverAdapter.sendOperation(a,this.cursor)},d.prototype.applyOperation=function(a){this.editorAdapter.applyOperation(a),this.updateCursor(),this.undoManager.transform(new j(a,null))},d}();var a=a||{};a.AttributeConstants={BOLD:"b",ITALIC:"i",UNDERLINE:"u",FONT:"f",FONT_SIZE:"fs",COLOR:"c",LINE_SENTINEL:"l",LINE_INDENT:"li",LIST_TYPE:"lt"};var a=a||{};a.RichTextCodeMirror=function(){function b(a,b){this.codeMirror=a,this.options_=b||{},this.currentAttributes_=null;var c=this;this.annotationList_=new f(function(a,b){c.onAnnotationsChanged_(a,b)}),this.initAnnotationList_(),e(this,"onCodeMirrorBeforeChange_"),e(this,"onCodeMirrorChange_"),e(this,"onCursorActivity_"),this.codeMirror.on("beforeChange",this.onCodeMirrorBeforeChange_),this.codeMirror.on("change",this.onCodeMirrorChange_),this.codeMirror.on("cursorActivity",this.onCursorActivity_),this.changeId_=0,this.outstandingChanges_={}}function c(a){this.attributes=a||{}}function d(a){for(var b in a)return!1;return!0}function e(a,b){var c=a[b];a[b]=function(){c.apply(a,arguments)}}var f=a.AnnotationList,g=a.Span,h=a.utils,i=a.AttributeConstants,j="cmrt-",k="cmrt-",l={c:"color",fs:"font-size"},m={};h.makeEventEmitter(b,["change","attributesChange"]);var n="";return b.LineSentinelCharacter=n,b.prototype.detach=function(){this.codeMirror.off("beforeChange",this.onCodeMirrorBeforeChange_),this.codeMirror.off("change",this.onCodeMirrorChange_),this.codeMirror.off("cursorActivity",this.onCursorActivity_),this.clearAnnotations_()},b.prototype.toggleAttribute=function(a){if(this.emptySelection_()){var b=this.getCurrentAttributes_();b[a]===!0?delete b[a]:b[a]=!0,this.currentAttributes_=b}else{var c=this.getCurrentAttributes_(),d=c[a]!==!0;this.setAttribute(a,d)}},b.prototype.setAttribute=function(a,b){var c=this.codeMirror;if(this.emptySelection_()){var d=this.getCurrentAttributes_();b===!1?delete d[a]:d[a]=b,this.currentAttributes_=d}else this.updateTextAttributes(c.indexFromPos(c.getCursor("start")),c.indexFromPos(c.getCursor("end")),function(c){b===!1?delete c[a]:c[a]=b}),this.updateCurrentAttributes_()},b.prototype.updateTextAttributes=function(a,b,e,f){var h={},i=h,j=a,k=this;this.annotationList_.updateSpan(new g(a,b-a),function(a,b){var g={};for(var h in a.attributes)g[h]=a.attributes[h];e(g);var l={},m={};return k.computeChangedAttributes_(a.attributes,g,l,m),d(l)||(i.next={start:j,end:j+b,attributes:l,attributesInverse:m,origin:f},i=i.next),j+=b,new c(g)}),h.next&&this.trigger("attributesChange",this,h.next)},b.prototype.computeChangedAttributes_=function(a,b,c,d){var e,f={};for(e in a)f[e]=!0;for(e in b)f[e]=!0;for(e in f)e in b?e in a?a[e]!==b[e]&&(c[e]=b[e],d[e]=a[e]):(c[e]=b[e],d[e]=!1):(c[e]=!1,d[e]=a[e])},b.prototype.toggleLineAttribute=function(a,b){var c,d=this.getCurrentLineAttributes_();c=a in d&&d[a]===b?!1:b,this.setLineAttribute(a,c)},b.prototype.setLineAttribute=function(a,b){this.updateLineAttributesForSelection(function(c){b===!1?delete c[a]:c[a]=b})},b.prototype.updateLineAttributesForSelection=function(a){var b=this.codeMirror,c=b.getCursor("start"),d=b.getCursor("end"),e=c.line,f=d.line,g=b.getLine(f),h=this.areLineSentinelCharacters_(g.substr(0,d.ch));f>e&&h&&f--,this.updateLineAttributes(e,f,a)},b.prototype.updateLineAttributes=function(a,b,c){for(var d=a;b>=d;d++){var e=this.codeMirror.getLine(d),f=this.codeMirror.indexFromPos({line:d,ch:0});if(e[0]!==n){var g={};g[i.LINE_SENTINEL]=!0,c(g),this.insertText(f,n,g)}else this.updateTextAttributes(f,f+1,c)}},b.prototype.replaceText=function(a,b,c,d,e){this.changeId_++;var f=k+this.changeId_;this.outstandingChanges_[f]={origOrigin:e,attributes:d};var g=this.codeMirror,h=g.posFromIndex(a),i="number"==typeof b?g.posFromIndex(b):null;g.replaceRange(c,h,i,f)},b.prototype.insertText=function(a,b,c,d){this.replaceText(a,null,b,c,d)},b.prototype.removeText=function(a,b,c){var d=this.codeMirror;d.replaceRange("",d.posFromIndex(a),d.posFromIndex(b),c)},b.prototype.getAttributeSpans=function(a,b){for(var c=[],d=this.annotationList_.getAnnotatedSpansForSpan(new g(a,b-a)),e=0;e<d.length;e++)c.push({length:d[e].length,attributes:d[e].annotation.attributes});return c},b.prototype.end=function(){var a=this.codeMirror.lineCount()-1;return this.codeMirror.indexFromPos({line:a,ch:this.codeMirror.getLine(a).length})},b.prototype.getText=function(a,b){var c=this.codeMirror.posFromIndex(a),d=this.codeMirror.posFromIndex(b);return this.codeMirror.getRange(c,d)},b.prototype.initAnnotationList_=function(){var a=this.end();0!==a&&this.annotationList_.insertAnnotatedSpan(new g(0,a),new c)},b.prototype.onAnnotationsChanged_=function(a,b){for(var c,d={},e=0;e<a.length;e++){var f=a[e].annotation.attributes;i.LINE_SENTINEL in f&&(d[this.codeMirror.posFromIndex(a[e].pos).line]=!0),c=a[e].getAttachedObject(),c&&c.clear()}for(e=0;e<b.length;e++){var g=b[e].annotation,h=this.getClassNameForAttributes_(g.attributes),j=i.LINE_SENTINEL in g.attributes;if(""!==h){var k=this.codeMirror.posFromIndex(b[e].pos);if(j)d[k.line]=!0;else{var l=this.codeMirror.posFromIndex(b[e].pos+b[e].length);c=this.codeMirror.markText(k,l,{className:h}),b[e].attachObject(c)}}}for(var m in d)!function(a,b){setTimeout(function(){var c=a.codeMirror.getLineNumber(b);a.markLineSentinelCharactersForChangedLines_(c,c)},0)}(this,this.codeMirror.getLineHandle(Number(m)))},b.prototype.addStyleWithCSS_=function(a){var b=document.getElementsByTagName("head")[0],c=document.createElement("style");c.type="text/css",c.styleSheet?c.styleSheet.cssText=a:c.appendChild(document.createTextNode(a)),b.appendChild(c)},b.prototype.getClassNameForAttributes_=function(b){var c="";for(var d in b){var e=b[d];if(d===i.LINE_SENTINEL)a.utils.assert(e===!0,"LINE_SENTINEL attribute should be true if it exists.");else{var f=(this.options_.cssPrefix||j)+d;if(e!==!0){d!==i.FONT_SIZE||"string"==typeof e&&-1!==e.indexOf("px",e.length-2)||(e+="px");var g=e.toString().toLowerCase().replace(/[^a-z0-9-_]/g,"-");f+="-"+g,l[d]&&(m[d]||(m[d]={}),m[d][g]||(m[d][g]=!0,this.addStyleWithCSS_("."+f+"{"+l[d]+":"+e+"}")))}c=c+" "+f}}return c},b.prototype.lineClassRemover_=function(a){var b=this.codeMirror,c=b.getLineHandle(a);return{clear:function(){b.removeLineClass(c,"text",".*")}}},b.prototype.emptySelection_=function(){var a=this.codeMirror.getCursor("start"),b=this.codeMirror.getCursor("end");return a.line===b.line&&a.ch===b.ch},b.prototype.onCodeMirrorBeforeChange_=function(a,b){if("+input"===b.origin||"paste"===b.origin){for(var c=[],d=0;d<b.text.length;d++){var e=b.text[d];e=e.replace(new RegExp(n,"g"),""),c.push(e)}b.update(b.from,b.to,c)}},b.prototype.onCodeMirrorChange_=function(a,b){for(var d={},e=d,f=b;f;){var h=this.codeMirror.indexFromPos(f.from),i=f.removed.join("\n");if(i.length>0){for(var j=this.annotationList_.getAnnotatedSpansForSpan(new g(h,i.length)),k=0,l=0;l<j.length;l++){var m=j[l];e.next={start:h,end:h+m.length,removedAttributes:m.annotation.attributes,removed:i.substr(k,m.length),attributes:{},text:"",origin:f.origin},e=e.next,k+=m.length}this.annotationList_.removeSpan(new g(h,i.length))}var n=f.text.join("\n"),o=f.origin;if(n.length>0){var p;"+input"===f.origin||"paste"===f.origin?p=this.currentAttributes_||{}:o in this.outstandingChanges_?(p=this.outstandingChanges_[o].attributes,o=this.outstandingChanges_[o].origOrigin,delete this.outstandingChanges_[o]):p={},this.annotationList_.insertAnnotatedSpan(new g(h,n.length),new c(p)),e.next={start:h,end:h,removedAttributes:{},removed:"",text:n,attributes:p,origin:o},e=e.next}f=f.next}this.markLineSentinelCharactersForChanges_(b),d.next&&this.trigger("change",this,d.next)},b.prototype.markLineSentinelCharactersForChanges_=function(a){for(var b=Number.MAX_VALUE,c=-1,d=a;d;){var e=d.from.line;d.from.ch,(d.removed.length>1||d.removed[0].indexOf(n)>=0)&&(b=Math.min(b,e),c=Math.max(c,e)),d.text.length>1?(b=Math.min(b,e),c=Math.max(c,e+d.text.length-1)):d.text[0].indexOf(n)>=0&&(b=Math.min(b,e),c=Math.max(c,e)),d=d.next}this.markLineSentinelCharactersForChangedLines_(b,c)},b.prototype.markLineSentinelCharactersForChangedLines_=function(a,b){if(a<Number.MAX_VALUE)for(;a>0&&this.lineIsListItemOrIndented_(a-1);)a--;if(b>-1)for(var c=this.codeMirror.lineCount();c>b+1&&this.lineIsListItemOrIndented_(b+1);)b++;for(var d=[1,1,1,1,1,1,1],e=this.codeMirror,f=a;b>=f;f++){var g=e.getLine(f),h=e.getLineHandle(f);if(e.removeLineClass(h,"text",".*"),g.length>0)for(var i=g.indexOf(n);i>=0;){for(var j=i;i<g.length&&g[i]===n;){for(var k=e.findMarksAt({line:f,ch:i}),l=0;l<k.length;l++)k[l].isForLineSentinel&&k[l].clear();i++}this.markLineSentinelCharacters_(f,j,i,d),i=g.indexOf(n,i)}else for(l=0;l<d.length;l++)d[l]=1}},b.prototype.markLineSentinelCharacters_=function(a,b,c,d){var e=this.codeMirror,f=null,g=null,h=function(){var a=g.find();return a?a.from.line:null};if(0===b){var j=this.getLineAttributes_(a),k=j[i.LIST_TYPE],l=j[i.LINE_INDENT]||0;k&&0===l&&(l=1),l>=d.length&&(l=d.length-1),"o"===k?(f=this.makeOrderedListElement_(d[l]),d[l]++):"u"===k?(f=this.makeUnorderedListElement_(),d[l]=1):"t"===k?(f=this.makeTodoListElement_(!1,h),d[l]=1):"tc"===k&&(f=this.makeTodoListElement_(!0,h),d[l]=1);var m=this.getClassNameForAttributes_(j);""!==m&&this.codeMirror.addLineClass(a,"text",m);for(var n=l+1;n<d.length;n++)d[n]=1}var o={inclusiveLeft:!0,collapsed:!0};f&&(o.replacedWith=f);var g=e.markText({line:a,ch:b},{line:a,ch:c},o);g.isForLineSentinel=!0},b.prototype.makeOrderedListElement_=function(a){return h.elt("div",a+".",{style:"margin-left: -20px; display:inline-block; width:15px;"})},b.prototype.makeUnorderedListElement_=function(){return h.elt("div","•",{style:"margin-left: -20px; display:inline-block; width:15px;"})},b.prototype.toggleTodo=function(a){var b,c=i.LIST_TYPE,d=this.getCurrentLineAttributes_();c in d&&("t"===d[c]||"tc"===d[c])?"t"===d[c]?b="tc":"tc"===d[c]&&(b=a?"t":!1):b="t",this.setLineAttribute(c,b)},b.prototype.makeTodoListElement_=function(a,b){var c={type:"checkbox",style:"margin-left: -20px; display:inline-block; width:15px; margin-top: -2px;"};a&&(c.checked=!0);var d=h.elt("input",!1,c);return d.onclick=function(a){a.preventDefault(),this.codeMirror.setCursor({line:b(),ch:0}),this.toggleTodo(!0)}.bind(this),d},b.prototype.lineIsListItemOrIndented_=function(a){var b=this.getLineAttributes_(a);return(b[i.LIST_TYPE]||!1)!==!1||0!==(b[i.LINE_INDENT]||0)},b.prototype.onCursorActivity_=function(){this.updateCurrentAttributes_()},b.prototype.getCurrentAttributes_=function(){return this.currentAttributes_||this.updateCurrentAttributes_(),this.currentAttributes_},b.prototype.updateCurrentAttributes_=function(){var b,c=this.codeMirror,d=c.indexFromPos(c.getCursor("anchor")),e=c.indexFromPos(c.getCursor("head"));b=d>e?e+1:e;var f=this.annotationList_.getAnnotatedSpansForPos(b);this.currentAttributes_={};var g={};f.length>0&&!(i.LINE_SENTINEL in f[0].annotation.attributes)?g=f[0].annotation.attributes:f.length>1&&(a.utils.assert(!(i.LINE_SENTINEL in f[1].annotation.attributes),"Cursor can't be between two line sentinel characters."),g=f[1].annotation.attributes);for(var h in g)this.currentAttributes_[h]=g[h];delete this.currentAttributes_.l,delete this.currentAttributes_.lt},b.prototype.getCurrentLineAttributes_=function(){var a=this.codeMirror,b=a.getCursor("anchor"),c=a.getCursor("head"),d=c.line;return 0===c.ch&&b.line<c.line&&d--,this.getLineAttributes_(d)},b.prototype.getLineAttributes_=function(b){var c={},d=this.codeMirror.getLine(b);if(d.length>0&&d[0]===n){var e=this.codeMirror.indexFromPos({line:b,ch:0}),f=this.annotationList_.getAnnotatedSpansForSpan(new g(e,1));a.utils.assert(1===f.length);for(var h in f[0].annotation.attributes)c[h]=f[0].annotation.attributes[h]}return c},b.prototype.clearAnnotations_=function(){this.annotationList_.updateSpan(new g(0,this.end()),function(){return new c({})})},b.prototype.newline=function(){var a=this.codeMirror;if(this.emptySelection_()){var b=a.getCursor("head").line,c=this.getLineAttributes_(b),d=c[i.LIST_TYPE];d&&1===a.getLine(b).length?this.updateLineAttributes(b,b,function(a){delete a[i.LIST_TYPE],delete a[i.LINE_INDENT]}):(a.replaceSelection("\n","end","+input"),d&&this.updateLineAttributes(b+1,b+1,function(a){for(var b in c)a[b]=c[b];"tc"===d&&(a[i.LIST_TYPE]="t")}))}else a.replaceSelection("\n","end","+input")},b.prototype.deleteLeft=function(){var a=this.codeMirror,b=a.getCursor("head"),c=this.getLineAttributes_(b.line),d=c[i.LIST_TYPE],e=c[i.LINE_INDENT],f=this.emptySelection_()&&1===b.ch;f&&d?this.updateLineAttributes(b.line,b.line,function(a){delete a[i.LIST_TYPE],delete a[i.LINE_INDENT]}):f&&e&&e>0?this.updateLineAttributes(b.line,b.line,function(a){a[i.LINE_INDENT]--}):a.deleteH(-1,"char")},b.prototype.deleteRight=function(){var a=this.codeMirror,b=a.getCursor("head"),c=a.getLine(b.line),d=this.areLineSentinelCharacters_(c),e=b.line+1<a.lineCount()?a.getLine(b.line+1):"";this.emptySelection_()&&d&&e[0]===n?a.replaceRange("",{line:b.line,ch:0},{line:b.line+1,ch:0},"+input"):a.deleteH(1,"char")},b.prototype.indent=function(){this.updateLineAttributesForSelection(function(a){var b=a[i.LINE_INDENT],c=a[i.LIST_TYPE];b&&6>b?a[i.LINE_INDENT]++:a[i.LINE_INDENT]=c?2:1})},b.prototype.unindent=function(){this.updateLineAttributesForSelection(function(a){var b=a[i.LINE_INDENT],c=a[i.LIST_TYPE];b&&b>1?a[i.LINE_INDENT]=b-1:(a[i.LINE_INDENT]=!1,c&&(a[i.LIST_TYPE]=!1))})},b.prototype.getText=function(){return this.codeMirror.getValue().replace(new RegExp(n,"g"),"")},b.prototype.areLineSentinelCharacters_=function(a){for(var b=0;b<a.length;b++)if(a[b]!==n)return!1;return!0},c.prototype.equals=function(a){if(!(a instanceof c))return!1;var b;for(b in this.attributes)if(a.attributes[b]!==this.attributes[b])return!1;for(b in a.attributes)if(a.attributes[b]!==this.attributes[b])return!1;return!0},b}();var a=a||{};a.RichTextCodeMirrorAdapter=function(){"use strict";function b(a){this.rtcm=a,this.cm=a.codeMirror,g(this,"onChange"),g(this,"onAttributesChange"),g(this,"onCursorActivity"),g(this,"onFocus"),g(this,"onBlur"),this.rtcm.on("change",this.onChange),this.rtcm.on("attributesChange",this.onAttributesChange),this.cm.on("cursorActivity",this.onCursorActivity),this.cm.on("focus",this.onFocus),this.cm.on("blur",this.onBlur)}function c(a,b){return a.line<b.line?-1:a.line>b.line?1:a.ch<b.ch?-1:a.ch>b.ch?1:0}function d(a,b){return 0===c(a,b)}function e(a){var b=a.lineCount()-1;return a.indexFromPos({line:b,ch:a.getLine(b).length})}function f(a,b){if(!a)throw new Error(b||"assertion error")}function g(a,b){var c=a[b];a[b]=function(){c.apply(a,arguments)}}function h(a){for(var b in a)return!1;return!0}var i=a.TextOperation,j=a.WrappedOperation,k=a.Cursor;b.prototype.detach=function(){this.rtcm.off("change",this.onChange),this.rtcm.off("attributesChange",this.onAttributesChange),this.cm.off("cursorActivity",this.onCursorActivity),this.cm.off("focus",this.onFocus),this.cm.off("blur",this.onBlur)},b.operationFromCodeMirrorChange=function(a,b){for(var c=[],d=0;a;)c[d++]=a,a=a.next;var f=e(b),g=(new i).retain(f),h=(new i).retain(f);for(d=c.length-1;d>=0;d--){a=c[d];var j=a.start,k=f-j-a.text.length;g=(new i).retain(j)["delete"](a.removed.length).insert(a.text,a.attributes).retain(k).compose(g),h=h.compose((new i).retain(j)["delete"](a.text.length).insert(a.removed,a.removedAttributes).retain(k)),f+=a.removed.length-a.text.length}return[g,h]},b.operationFromAttributesChange=function(a,b){for(var c=e(b),d=new i,g=new i,h=0;a;){var j=a.start-h;f(j>=0),d.retain(j),g.retain(j);var k=a.end-a.start;d.retain(k,a.attributes),g.retain(k,a.attributesInverse),h=a.start+k,a=a.next}return d.retain(c-h),g.retain(c-h),[d,g]},b.applyOperationToCodeMirror=function(a,b){b.codeMirror.operation(function(){for(var c=a.ops,d=0,e=0,f=c.length;f>e;e++){var g=c[e];g.isRetain()?(h(g.attributes)||b.updateTextAttributes(d,d+g.chars,function(a){for(var b in g.attributes)g.attributes[b]===!1?delete a[b]:a[b]=g.attributes[b]},"RTCMADAPTER"),d+=g.chars):g.isInsert()?(b.insertText(d,g.text,g.attributes,"RTCMADAPTER"),d+=g.text.length):g.isDelete()&&b.removeText(d,d+g.chars,"RTCMADAPTER")}})},b.prototype.registerCallbacks=function(a){this.callbacks=a},b.prototype.onChange=function(a,c){if("RTCMADAPTER"!==c.origin){var d=b.operationFromCodeMirrorChange(c,this.cm);this.trigger("change",d[0],d[1])}},b.prototype.onAttributesChange=function(a,c){if("RTCMADAPTER"!==c.origin){var d=b.operationFromAttributesChange(c,this.cm);this.trigger("change",d[0],d[1])}},b.prototype.onCursorActivity=b.prototype.onFocus=function(){this.trigger("cursorActivity")},b.prototype.onBlur=function(){this.cm.somethingSelected()||this.trigger("blur")},b.prototype.getValue=function(){return this.cm.getValue()},b.prototype.getCursor=function(){var a,b=this.cm,c=b.getCursor(),e=b.indexFromPos(c);if(b.somethingSelected()){var f=b.getCursor(!0),g=d(c,f)?b.getCursor(!1):f;a=b.indexFromPos(g)}else a=e;return new k(e,a)},b.prototype.setCursor=function(a){this.cm.setSelection(this.cm.posFromIndex(a.position),this.cm.posFromIndex(a.selectionEnd))};var l=function(){if("undefined"!=typeof document){var a={},b=document.createElement("style");document.documentElement.getElementsByTagName("head")[0].appendChild(b);var c=b.sheet;return function(b){a[b]||(a[b]=!0,c.insertRule(b,(c.cssRules||c.rules).length))}}}();return b.prototype.setOtherCursor=function(a,b,c){var d=this.cm.posFromIndex(a.position);if("string"==typeof b&&b.match(/^#[a-fA-F0-9]{3,6}$/)){var e=this.rtcm.end();if("object"==typeof a&&"number"==typeof a.position&&"number"==typeof a.selectionEnd&&!(a.position<0||a.position>e||a.selectionEnd<0||a.selectionEnd>e)){if(a.position===a.selectionEnd){var f=this.cm.cursorCoords(d),g=document.createElement("pre");return g.className="other-client",g.style.borderLeftWidth="2px",g.style.borderLeftStyle="solid",g.innerHTML="&nbsp;",g.style.borderLeftColor=b,g.style.height=.9*(f.bottom-f.top)+"px",g.style.marginTop=f.top-f.bottom+"px",g.setAttribute("data-clientid",c),g.style.zIndex=0,this.cm.addWidget(d,g,!1),{clear:function(){var a=g.parentNode;a&&a.removeChild(g)}}}var h="selection-"+b.replace("#",""),i="."+h+" { background: "+b+"; }";l(i);var j,k;return a.selectionEnd>a.position?(j=d,k=this.cm.posFromIndex(a.selectionEnd)):(j=this.cm.posFromIndex(a.selectionEnd),k=d),this.cm.markText(j,k,{className:h})}}},b.prototype.trigger=function(a){var b=Array.prototype.slice.call(arguments,1),c=this.callbacks&&this.callbacks[a];c&&c.apply(this,b)},b.prototype.applyOperation=function(a){b.applyOperationToCodeMirror(a,this.rtcm)},b.prototype.registerUndo=function(a){this.cm.undo=a},b.prototype.registerRedo=function(a){this.cm.redo=a},b.prototype.invertOperation=function(a){for(var b,c,d=0,e=this.rtcm.codeMirror,f=new i,g=0;g<a.wrapped.ops.length;g++){var k=a.wrapped.ops[g];if(k.isRetain())if(h(k.attributes))f.retain(k.chars),d+=k.chars;else for(b=this.rtcm.getAttributeSpans(d,d+k.chars),c=0;c<b.length;c++){var l={};for(var m in k.attributes){var n=k.attributes[m],o=b[c].attributes[m];n===!1?o&&(l[m]=o):n!==o&&(l[m]=o||!1)}f.retain(b[c].length,l),d+=b[c].length}else if(k.isInsert())f["delete"](k.text.length);else if(k.isDelete()){var p=e.getRange(e.posFromIndex(d),e.posFromIndex(d+k.chars));b=this.rtcm.getAttributeSpans(d,d+k.chars);var q=0;for(c=0;c<b.length;c++)f.insert(p.substr(q,b[c].length),b[c].attributes),q+=b[c].length;d+=k.chars}}return new j(f,a.meta.invert())},b}();var a=a||{};a.Formatting=function(){function b(a){return this instanceof b?(this.attributes=a||{},void 0):new b(a)}var c=a.AttributeConstants;return b.prototype.cloneWithNewAttribute_=function(a,c){var d={};for(var e in this.attributes)d[e]=this.attributes[e];return c===!1?delete d[a]:d[a]=c,new b(d)},b.prototype.bold=function(a){return this.cloneWithNewAttribute_(c.BOLD,a)},b.prototype.italic=function(a){return this.cloneWithNewAttribute_(c.ITALIC,a)},b.prototype.underline=function(a){return this.cloneWithNewAttribute_(c.UNDERLINE,a)},b.prototype.font=function(a){return this.cloneWithNewAttribute_(c.FONT,a)},b.prototype.fontSize=function(a){return this.cloneWithNewAttribute_(c.FONT_SIZE,a)},b.prototype.color=function(a){return this.cloneWithNewAttribute_(c.COLOR,a)},b}();var a=a||{};a.Text=function(){function b(c,d){return this instanceof b?(this.text=c,this.formatting=d||a.Formatting(),void 0):new b(c,d)}return b}();var a=a||{};a.LineFormatting=function(){function b(a){return this instanceof b?(this.attributes=a||{},this.attributes[c.LINE_SENTINEL]=!0,void 0):new b(a)}var c=a.AttributeConstants;return b.LIST_TYPE={NONE:!1,ORDERED:"o",UNORDERED:"u",TODO:"t",TODOCHECKED:"tc"},b.prototype.cloneWithNewAttribute_=function(a,c){var d={};for(var e in this.attributes)d[e]=this.attributes[e];return c===!1?delete d[a]:d[a]=c,new b(d)},b.prototype.indent=function(a){return this.cloneWithNewAttribute_(c.LINE_INDENT,a)},b.prototype.listItem=function(b){return a.utils.assert(b===!1||"u"===b||"o"===b||"t"===b||"tc"===b),this.cloneWithNewAttribute_(c.LIST_TYPE,b)},b.prototype.getIndent=function(){return this.attributes[c.LINE_INDENT]||0},b.prototype.getListItem=function(){return this.attributes[c.LIST_TYPE]||!1},b}();var a=a||{};a.Line=function(){function b(c,d){return this instanceof b?("[object Array]"!==Object.prototype.toString.call(c)&&(c="undefined"==typeof c?[]:[c]),this.textPieces=c,this.formatting=d||a.LineFormatting(),void 0):new b(c,d)}return b}();var a=a||{};a.ParseHtml=function(){function b(b,c,d){this.listType=b||i.UNORDERED,this.lineFormatting=c||a.LineFormatting(),this.textFormatting=d||a.Formatting()}function c(){this.lines=[],this.currentLine=[],this.currentLineListItemType=null}function d(a){var d=document.createElement("div");d.innerHTML=a;var f=new c,g=new b;return e(d,g,f),f.lines}function e(b,c,d){switch(b.nodeType){case Node.TEXT_NODE:var e=b.nodeValue.replace(/\s+/g," ");d.currentLine.push(a.Text(e,c.textFormatting));break;case Node.ELEMENT_NODE:var j=b.getAttribute("style")||"";switch(c=c.withTextFormatting(h(c.textFormatting,j)),b.nodeName.toLowerCase()){case"div":case"h1":case"h2":case"h3":case"p":d.newlineIfNonEmpty(c),f(b,c,d),d.newlineIfNonEmpty(c);break;case"b":case"strong":f(b,c.withTextFormatting(c.textFormatting.bold(!0)),d);break;case"u":f(b,c.withTextFormatting(c.textFormatting.underline(!0)),d);break;case"i":case"em":f(b,c.withTextFormatting(c.textFormatting.italic(!0)),d);break;case"font":var k=b.getAttribute("face"),l=b.getAttribute("color"),m=parseInt(b.getAttribute("size"));k&&(c=c.withTextFormatting(c.textFormatting.font(k))),l&&(c=c.withTextFormatting(c.textFormatting.color(l))),m&&(c=c.withTextFormatting(c.textFormatting.fontSize(m))),f(b,c,d);break;case"br":d.newline(c);break;case"ul":d.newlineIfNonEmptyOrListItem(c),f(b,c.withListType(i.UNORDERED).withIncreasedIndent(),d),d.newlineIfNonEmpty(c);break;case"ol":d.newlineIfNonEmptyOrListItem(c),f(b,c.withListType(i.ORDERED).withIncreasedIndent(),d),d.newlineIfNonEmpty(c);break;case"li":g(b,c,d);break;default:f(b,c,d)}}}function f(a,b,c){if(a.hasChildNodes())for(var d=0;d<a.childNodes.length;d++)e(a.childNodes[d],b,c)}function g(a,b,c){c.newlineIfNonEmptyOrListItem(b),c.makeListItem(b.listType);var d=c.currentLine;f(a,b,c),(d===c.currentLine||c.currentLine.length>0)&&c.newline(b)}function h(a,b){for(var c=b.split(";"),d=0;d<c.length;d++){var e=c[d].split(":");if(2===e.length){var f=e[0].trim().toLowerCase(),g=e[1].trim();switch(f){case"text-decoration":var h=g.indexOf("underline")>=0;a=a.underline(h);break;case"font-weight":var i="bold"===g||parseInt(g)>=600;a=a.bold(i);break;case"font-style":var j="italic"===g||"oblique"===g;a=a.italic(j);break;case"color":a=a.color(g.toLowerCase());break;case"font-size":switch(g){case"xx-small":a=a.fontSize(9);break;case"x-small":a=a.fontSize(10);break;case"small":a=a.fontSize(12);break;case"medium":a=a.fontSize(14);break;case"large":a=a.fontSize(18);break;case"x-large":a=a.fontSize(24);break;case"xx-large":a=a.fontSize(32);break;default:a=a.fontSize(parseInt(g))}break;case"font-family":var k=g.split(",")[0].trim();k=k.replace(/['"]/g,""),k=k.replace(/\w\S*/g,function(a){return a.charAt(0).toUpperCase()+a.substr(1).toLowerCase()}),a=a.font(k)}}}return a}var i=a.LineFormatting.LIST_TYPE;return b.prototype.withTextFormatting=function(a){return new b(this.listType,this.lineFormatting,a)},b.prototype.withLineFormatting=function(a){return new b(this.listType,a,this.textFormatting)},b.prototype.withListType=function(a){return new b(a,this.lineFormatting,this.textFormatting)},b.prototype.withIncreasedIndent=function(){var a=this.lineFormatting.indent(this.lineFormatting.getIndent()+1);return new b(this.listType,a,this.textFormatting)},c.prototype.newlineIfNonEmpty=function(a){this.currentLine.length>0&&this.newline(a)},c.prototype.newlineIfNonEmptyOrListItem=function(a){(this.currentLine.length>0||null!==this.currentLineListItemType)&&this.newline(a)},c.prototype.newline=function(b){var c=b.lineFormatting;null!==this.currentLineListItemType&&(c=c.listItem(this.currentLineListItemType),this.currentLineListItemType=null),this.lines.push(a.Line(this.currentLine,c)),this.currentLine=[]},c.prototype.makeListItem=function(a){this.currentLineListItemType=a},c.prototype.isListItem=function(){return null!==this.currentLineListItemType},d}();var a=a||{};return a.Firepad=function(b){function c(a,b,e){if(!(this instanceof c))return new c(a,b,e);if(!o)throw new Error("Couldn't find CodeMirror.  Did you forget to include codemirror.js?");if(b instanceof o){this.codeMirror_=b;var f=this.codeMirror_.getValue();if(""!==f)throw new Error("Can't initialize Firepad with a CodeMirror instance that already contains text.")}else this.codeMirror_=new o(b);var i=this.codeMirror_.getWrapperElement();this.firepadWrapper_=m.elt("div",null,{"class":"firepad"}),i.parentNode.replaceChild(this.firepadWrapper_,i),this.firepadWrapper_.appendChild(i),this.codeMirror_.firepad=this,this.options_=e||{},this.getOption("richTextShortcuts",!1)&&(o.keyMap.richtext||this.initializeKeyMap_(),this.codeMirror_.setOption("keyMap","richtext"),this.firepadWrapper_.className+=" firepad-richtext"),this.getOption("richTextToolbar",!1)&&(this.addToolbar_(),this.firepadWrapper_.className+=" firepad-richtext firepad-with-toolbar"),this.addPoweredByLogo_(),this.codeMirror_.refresh();var l=this.getOption("userId",a.push().name()),n=this.getOption("userColor",d(l));this.richTextCodeMirror_=new h(this.codeMirror_,{cssPrefix:"firepad-"}),this.firebaseAdapter_=new j(a,l,n),this.cmAdapter_=new g(this.richTextCodeMirror_),this.client_=new k(this.firebaseAdapter_,this.cmAdapter_);var p=this;this.firebaseAdapter_.on("ready",function(){p.ready_=!0,p.trigger("ready")})}function d(a){for(var b=1,c=0;c<a.length;c++)b=17*(b+a.charCodeAt(c))%360;var d=b/360;return f(d,1,.85)}function e(a,b,c){function d(a){var b=Math.round(255*a).toString(16);return 1===b.length?"0"+b:b}return"#"+d(a)+d(b)+d(c)}function f(a,b,c){if(0===b)return e(c,c,c);var d=.5>c?c*(1+b):c+b-b*c,f=2*c-d,g=function(a){return 0>a&&(a+=1),a>1&&(a-=1),1>6*a?f+6*(d-f)*a:1>2*a?d:2>3*a?f+6*(d-f)*(2/3-a):f};return e(g(a+1/3),g(a),g(a-1/3))}var g=a.RichTextCodeMirrorAdapter,h=a.RichTextCodeMirror,i=a.RichTextToolbar,j=a.FirebaseAdapter,k=a.EditorClient,l=a.AttributeConstants,m=a.utils,n=a.LineFormatting.LIST_TYPE,o=b.CodeMirror;return m.makeEventEmitter(c),c.fromCodeMirror=c,c.prototype.dispose=function(){this.zombie_=!0;var a=this.codeMirror_.getWrapperElement();this.firepadWrapper_.removeChild(a),this.firepadWrapper_.parentNode.replaceChild(a,this.firepadWrapper_),this.codeMirror_.firepad=null,"richtext"===this.codeMirror_.getOption("keyMap")&&this.codeMirror_.setOption("keyMap","default"),this.firebaseAdapter_.dispose(),this.cmAdapter_.detach(),this.richTextCodeMirror_.detach()},c.prototype.setUserId=function(a){this.firebaseAdapter_.setUserId(a)},c.prototype.setUserColor=function(a){this.firebaseAdapter_.setColor(a)},c.prototype.getText=function(){return this.assertReady_("getText"),this.richTextCodeMirror_.getText()},c.prototype.setText=function(b){function c(a,b){i.richTextCodeMirror_.insertText(f,a,b||null),f+=a.length,g="\n"===a[a.length-1]}function d(b){if(b instanceof a.Text)c(b.text,b.formatting.attributes);else{if("string"!=typeof b)throw console.error("Can't insert into firepad",b),"Can't insert into firepad: "+b;c(b)}}function e(a){g||c("\n"),c(h.LineSentinelCharacter,a.formatting.attributes);for(var b=0;b<a.textPieces.length;b++)d(a.textPieces[b]);c("\n")}this.assertReady_("setText"),"[object Array]"!==Object.prototype.toString.call(b)&&(b=[b]),this.codeMirror_.setValue("");for(var f=0,g=!0,i=this,j=0;j<b.length;j++)b[j]instanceof a.Line?e(b[j]):d(b[j])},c.prototype.getHtml=function(){function b(a){return a===n.ORDERED?"<ol>":"<ul>"}function c(a){return a===n.ORDERED?"</ol>":"</ul>"}for(var d=this.firebaseAdapter_.getDocument(),e="",f=!0,g=[],h=!1,i=0,j=d.ops[i];j;){m.assert(j.isInsert());var k=j.attributes;if(f){f=!1;var o=0,p=null;l.LINE_SENTINEL in k&&(o=k[l.LINE_INDENT]||0,p=k[l.LIST_TYPE]||null),p&&(o=o||1),h&&(e+="</li>",h=!1),m.assert(o>=0,"Indent must not be negative.");for(;g.length>o||o===g.length&&null!==p&&p!==g[g.length-1];)e+=c(g.pop());for(;g.length<o;){var q=p||n.UNORDERED;e+=b(q),g.push(q)}p&&(e+="<li>",h=!0)}if(l.LINE_SENTINEL in k)j=d.ops[++i];else{var r="",s="";for(var t in k){var u,v,w=k[t];t===l.BOLD||t===l.ITALIC||t===l.UNDERLINE?(m.assert(w===!0),u=v=t):t===l.FONT_SIZE?(u='span style="font-size: '+w,u+="string"!=typeof w||-1===w.indexOf("px",w.length-2)?'px"':'"',v="span"):t===l.FONT?(u='span style="font-family: '+w+'"',v="span"):t===l.COLOR?(u='span style="color: '+w+'"',v="span"):m.log(!1,"Encountered unknown attribute while rendering html: "+t),u&&(r+="<"+u+">"),v&&(s="</"+v+">"+s)}var x=j.text,y=x.indexOf("\n");y>=0?(f=!0,y<x.length-1?(j=new a.TextOp("insert",x.substr(y+1),k),x=x.substr(0,y+1)):j=d.ops[++i]):j=d.ops[++i],e+=r+this.textToHtml_(x)+s}}for(h&&(e+="</li>");g.length>0;)e+=c(g.pop());return e},c.prototype.textToHtml_=function(a){return a.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br />")},c.prototype.setHtml=function(b){var c=a.ParseHtml(b);this.setText(c)},c.prototype.isHistoryEmpty=function(){return this.assertReady_("isHistoryEmpty"),this.firebaseAdapter_.isHistoryEmpty()},c.prototype.bold=function(){this.richTextCodeMirror_.toggleAttribute(l.BOLD),this.codeMirror_.focus()},c.prototype.italic=function(){this.richTextCodeMirror_.toggleAttribute(l.ITALIC),this.codeMirror_.focus()},c.prototype.underline=function(){this.richTextCodeMirror_.toggleAttribute(l.UNDERLINE),this.codeMirror_.focus()},c.prototype.fontSize=function(a){this.richTextCodeMirror_.setAttribute(l.FONT_SIZE,a),this.codeMirror_.focus()},c.prototype.font=function(a){this.richTextCodeMirror_.setAttribute(l.FONT,a),this.codeMirror_.focus()
},c.prototype.color=function(a){this.richTextCodeMirror_.setAttribute(l.COLOR,a),this.codeMirror_.focus()},c.prototype.orderedList=function(){this.richTextCodeMirror_.toggleLineAttribute(l.LIST_TYPE,"o"),this.codeMirror_.focus()},c.prototype.unorderedList=function(){this.richTextCodeMirror_.toggleLineAttribute(l.LIST_TYPE,"u"),this.codeMirror_.focus()},c.prototype.todo=function(){this.richTextCodeMirror_.toggleTodo(),this.codeMirror_.focus()},c.prototype.newline=function(){this.richTextCodeMirror_.newline()},c.prototype.deleteLeft=function(){this.richTextCodeMirror_.deleteLeft()},c.prototype.deleteRight=function(){this.richTextCodeMirror_.deleteRight()},c.prototype.indent=function(){this.richTextCodeMirror_.indent()},c.prototype.unindent=function(){this.richTextCodeMirror_.unindent()},c.prototype.getOption=function(a,b){return a in this.options_?this.options_[a]:b},c.prototype.assertReady_=function(a){if(!this.ready_)throw new Error('You must wait for the "ready" event before calling '+a+".");if(this.zombie_)throw new Error("You can't use a Firepad after calling dispose()!")},c.prototype.addToolbar_=function(){var a=new i;a.on("bold",this.bold,this),a.on("italic",this.italic,this),a.on("underline",this.underline,this),a.on("font-size",this.fontSize,this),a.on("font",this.font,this),a.on("color",this.color,this),a.on("ordered-list",this.orderedList,this),a.on("unordered-list",this.unorderedList,this),a.on("todo",this.todo,this),this.firepadWrapper_.insertBefore(a.element(),this.firepadWrapper_.firstChild)},c.prototype.addPoweredByLogo_=function(){var a=m.elt("a",null,{"class":"powered-by-firepad"});a.setAttribute("href","http://www.firepad.io/"),a.setAttribute("target","_blank"),this.firepadWrapper_.appendChild(a)},c.prototype.initializeKeyMap_=function(){function a(a){return function(b){a.call(b.firepad)}}o.keyMap.richtext={"Ctrl-B":a(this.bold),"Cmd-B":a(this.bold),"Ctrl-I":a(this.italic),"Cmd-I":a(this.italic),"Ctrl-U":a(this.underline),"Cmd-U":a(this.underline),Enter:a(this.newline),Delete:a(this.deleteRight),Backspace:a(this.deleteLeft),Tab:a(this.indent),"Shift-Tab":a(this.unindent),fallthrough:["default"]}},c}(this),a.Firepad.Formatting=a.Formatting,a.Firepad.Text=a.Text,a.Firepad.LineFormatting=a.LineFormatting,a.Firepad.Line=a.Line,a.Firepad.TextOperation=a.TextOperation,a.Firepad}();